#!/usr/bin/env bash
# Abort commits that stage changes under /data from local clones
set -euo pipefail

# Allow overrides
if [[ "${VULCANO_ALLOW_LOCAL_DATA_COMMIT:-}" == "1" ]]; then
  exit 0
fi

# In CI, allow
if [[ "${CI:-}" == "true" || -n "${GITHUB_ACTIONS:-}" ]]; then
  exit 0
fi

# Detect staged changes under data/
if git diff --cached --name-only | grep -E '^(data/)'; then
  cat << 'MSG'
❌ Commit blocked: staged changes include files under /data/.

Data under /data is generated by n8n/GitHub Actions and should not be committed from local machines.

To proceed anyway (not recommended), set:
  VULCANO_ALLOW_LOCAL_DATA_COMMIT=1 git commit -m "..."

Recommended: keep /data excluded locally using sparse-checkout:
  ./scripts/setup-sparse-no-data.sh
MSG
  exit 1
fi

exit 0

