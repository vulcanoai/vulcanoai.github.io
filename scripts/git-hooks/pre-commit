#!/usr/bin/env bash
# Abort commits that stage changes under /data from local clones
set -euo pipefail

# Allow overrides
if [[ "${VULCANO_ALLOW_LOCAL_DATA_COMMIT:-}" == "1" ]]; then
  exit 0
fi

# In CI, allow
if [[ "${CI:-}" == "true" || -n "${GITHUB_ACTIONS:-}" ]]; then
  exit 0
fi

# Detect staged changes under data/
if git diff --cached --name-only | grep -E '^(data/)'; then
  cat << 'MSG'
❌ Commit blocked: staged changes include files under /data/.

Data under /data is generated by n8n/GitHub Actions and should not be committed from local machines.

To proceed anyway (not recommended), set:
  VULCANO_ALLOW_LOCAL_DATA_COMMIT=1 git commit -m "..."

Recommended: keep /data excluded locally using sparse-checkout:
  ./scripts/setup-sparse-no-data.sh
MSG
  exit 1
fi

# Block committing n8n workflow JSONs (keep production/admin wiring private)
if git diff --cached --name-only | grep -E '^(n8n/workflows/).+\.json$'; then
  if [[ "${VULCANO_ALLOW_WORKFLOW_COMMIT:-}" == "1" ]]; then
    :
  else
    cat << 'MSG'
❌ Commit blocked: staged changes include n8n workflow JSON files.

Production and admin workflow JSONs must not be committed to the public repo.
Keep real workflows private in n8n. Store only sanitized docs (no JSON) in docs/.

To override temporarily (not recommended):
  VULCANO_ALLOW_WORKFLOW_COMMIT=1 git commit -m "..."
MSG
    exit 1
  fi
fi

exit 0
